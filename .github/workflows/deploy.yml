name: Deploy Beta App

on:
  push:
    branches: [ deploy ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Validate required secrets exist
        run: |
          set -euo pipefail

          req() { [ -n "${1:-}" ] || { echo "::error::$2 missing"; exit 1; }; }

          req "${{ secrets.SSH_HOST }}" "SSH_HOST"
          req "${{ secrets.SSH_USER }}" "SSH_USER"
          req "${{ secrets.SSH_KEY_B64 }}" "SSH_KEY_B64"

          # Frontend (public build/runtime)
          req "${{ secrets.NEXT_PUBLIC_APP_ENV }}" "NEXT_PUBLIC_APP_ENV"
          req "${{ secrets.NEXT_PUBLIC_API_BASE }}" "NEXT_PUBLIC_API_BASE"

          # Backend
          req "${{ secrets.REDIS_URL }}" "REDIS_URL"
          req "${{ secrets.APP_BASE_URL }}" "APP_BASE_URL"
          req "${{ secrets.COGNITO_DOMAIN }}" "COGNITO_DOMAIN"
          req "${{ secrets.COGNITO_CLIENT_ID }}" "COGNITO_CLIENT_ID"
          req "${{ secrets.COGNITO_CLIENT_SECRET }}" "COGNITO_CLIENT_SECRET"
          req "${{ secrets.COGNITO_REDIRECT_URI }}" "COGNITO_REDIRECT_URI"
          req "${{ secrets.OPENAI_API_KEY }}" "OPENAI_API_KEY"

      - name: Prepare SSH key (decode from base64)
        run: |
          umask 077
          echo "${{ secrets.SSH_KEY_B64 }}" | base64 -d > id_ci.pem
          chmod 600 id_ci.pem

      - name: Smoke test SSH connection
        run: |
          ssh -i id_ci.pem \
            -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ServerAliveInterval=30 -o ServerAliveCountMax=20 \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" \
            'whoami && hostname && echo "âœ… SSH OK"'

      - name: Deploy over SSH (Docker Compose)
        env:
          # These exist on the runner; we will explicitly pass them into the SSH session below.
          NEXT_PUBLIC_APP_ENV: ${{ secrets.NEXT_PUBLIC_APP_ENV }}
          NEXT_PUBLIC_API_BASE: ${{ secrets.NEXT_PUBLIC_API_BASE }}

          REDIS_URL: ${{ secrets.REDIS_URL }}
          APP_BASE_URL: ${{ secrets.APP_BASE_URL }}
          COGNITO_DOMAIN: ${{ secrets.COGNITO_DOMAIN }}
          COGNITO_CLIENT_ID: ${{ secrets.COGNITO_CLIENT_ID }}
          COGNITO_CLIENT_SECRET: ${{ secrets.COGNITO_CLIENT_SECRET }}
          COGNITO_REDIRECT_URI: ${{ secrets.COGNITO_REDIRECT_URI }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          ssh -i id_ci.pem \
            -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -o ServerAliveInterval=30 -o ServerAliveCountMax=20 \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" \
            "NEXT_PUBLIC_APP_ENV='${NEXT_PUBLIC_APP_ENV}' \
             NEXT_PUBLIC_API_BASE='${NEXT_PUBLIC_API_BASE}' \
             REDIS_URL='${REDIS_URL}' \
             APP_BASE_URL='${APP_BASE_URL}' \
             COGNITO_DOMAIN='${COGNITO_DOMAIN}' \
             COGNITO_CLIENT_ID='${COGNITO_CLIENT_ID}' \
             COGNITO_CLIENT_SECRET='${COGNITO_CLIENT_SECRET}' \
             COGNITO_REDIRECT_URI='${COGNITO_REDIRECT_URI}' \
             OPENAI_API_KEY='${OPENAI_API_KEY}' \
             bash -se" <<'REMOTE'
          set -euo pipefail

          cd /home/ubuntu/apps/beta

          echo "== Resetting repo to origin/deploy =="
          git fetch origin
          git checkout deploy
          git reset --hard origin/deploy

          # IMPORTANT: remove ignored artifacts too
          git clean -ffdx || true
          rm -f .env.local .env.development .env.production || true

          echo "== Stop old non-docker service if it exists =="
          sudo systemctl stop beta-next || true
          sudo systemctl disable beta-next || true

          echo "== Writing env files (NOT committed to repo) =="
          mkdir -p deploy

          # NOTE: NO indentation inside these files (critical)
          cat > deploy/frontend.prod.env <<EOF
          NEXT_PUBLIC_APP_ENV=${NEXT_PUBLIC_APP_ENV}
          NEXT_PUBLIC_API_BASE=${NEXT_PUBLIC_API_BASE}
          EOF
          
          cat > deploy/backend.prod.env <<EOF
          REDIS_URL=${REDIS_URL}
          APP_BASE_URL=${APP_BASE_URL}
          COGNITO_DOMAIN=${COGNITO_DOMAIN}
          COGNITO_CLIENT_ID=${COGNITO_CLIENT_ID}
          COGNITO_CLIENT_SECRET=${COGNITO_CLIENT_SECRET}
          COGNITO_REDIRECT_URI=${COGNITO_REDIRECT_URI}
          OPENAI_API_KEY=${OPENAI_API_KEY}
          EOF

          echo "== Export build args for Next build =="
          export NEXT_PUBLIC_APP_ENV
          export NEXT_PUBLIC_API_BASE

          export BUILDKIT_PROGRESS=plain
          export NODE_OPTIONS="--max-old-space-size=768"

          echo "== Docker compose build+up =="
          docker compose -f docker-compose.prod.yml down || true
          docker compose -f docker-compose.prod.yml build --progress=plain
          docker compose -f docker-compose.prod.yml up -d

          echo "== Reload nginx =="
          sudo nginx -t
          sudo systemctl reload nginx

          echo "== Status =="
          docker compose -f docker-compose.prod.yml ps
          docker compose -f docker-compose.prod.yml logs --tail=120 || true
          REMOTE